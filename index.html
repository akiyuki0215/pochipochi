<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>åº—é ­å¯¾å¿œãƒŠãƒ“ï¼ˆMVPï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--brand:#004c99;--ink:#111827;--muted:#6b7280;--card:#ffffff;--line:#d1d5db;--btn:#e0e7ff;--btn-ink:#1e3a8a}
*{box-sizing:border-box}
body{font-family:"Noto Sans JP",sans-serif;background:#f8fafc;margin:0;color:var(--ink)}
header{background:linear-gradient(90deg,#004c99,#0a66c2);color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
.container{max-width:980px;margin:20px auto;padding:0 16px}
h3{margin:14px 0 8px 0}
.btn{background:var(--btn);color:var(--btn-ink);border:none;border-radius:10px;padding:10px 16px;margin:8px 8px 0 0;cursor:pointer;font-weight:700;box-shadow:0 1px 0 rgba(0,0,0,.05)}
.btn:hover{filter:brightness(.97)}
.toolbar{margin-top:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;margin-top:10px}
.path{font-size:12px;color:var(--muted);margin:6px 0 10px}
details.acc{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:8px;margin-top:16px}
#debug{display:none;margin-top:8px;border-left:4px solid #ef4444;background:#fff1f2;padding:8px 10px;border-radius:6px}
footer{padding:16px 0 40px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<header>
  <div>
    <div style="font-size:20px;font-weight:700;">åº—é ­å¯¾å¿œãƒŠãƒ“ï¼ˆMVPï¼‰</div>
    <div style="font-size:12px;opacity:.9">ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»ä¿è¨¼ã®ãƒŠãƒ¬ãƒƒã‚¸ã‚’JSONã§ç®¡ç†ã—ã€èª°ã§ã‚‚åŒã˜åˆ¤æ–­ã‚’</div>
  </div>
  <a id="formLink" href="https://forms.gle/2Sq1DwiNAvbHcRzG9" target="_blank" rel="noopener" class="btn">âœ‰ï¸ æ„è¦‹ãƒ»æ”¹å–„ææ¡ˆ</a>
</header>

<main class="container">
  <div class="path" id="path">é€²è¡Œï¼šãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠ</div>
  <div id="content" class="card">èª­ã¿è¾¼ã¿ä¸­...</div>
  <div class="toolbar">
    <button class="btn" id="backBtn" style="display:none">â† æˆ»ã‚‹</button>
    <button class="btn" id="resetBtn">æœ€åˆã‹ã‚‰</button>
  </div>

  <details class="acc" id="historyAcc">
    <summary>ğŸ•“ æ›´æ–°å±¥æ­´ï¼ˆã‚¿ãƒƒãƒ—ã§é–‹é–‰ï¼‰</summary>
    <div id="history">èª­ã¿è¾¼ã¿ä¸­...</div>
  </details>

  <div id="debug"></div>
</main>

<footer>Â© Niigata Division</footer>

<script>
const FORM_URL = "https://forms.gle/2Sq1DwiNAvbHcRzG9";
let DATA=null; const state={history:[],current:"ãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠ"}; let FLOW={nodes:{}};

function showError(msg){
  const box=document.getElementById('debug');
  box.textContent="ã‚¨ãƒ©ãƒ¼: "+msg;
  box.style.display='block';
}

async function loadJSON(path){
  const res = await fetch(path,{cache:'no-store'});
  if(!res.ok) throw new Error(path+" ã®å–å¾—ã«å¤±æ•—ï¼ˆHTTP "+res.status+"ï¼‰");
  return await res.json();
}

function renderStart(){
  const c=document.getElementById("content"); c.innerHTML="";
  const groups = (DATA && DATA.groups) ? DATA.groups : {
    domestic:["NEC","Fujitsu","Dynabook","VAIO","Mouse Computer"],
    overseas:["ASUS","Dell","Lenovo","MSI"],
    surface:["Surface"],
    apple:["Apple"]
  };
  [
    ["å›½å†…ãƒ¡ãƒ¼ã‚«ãƒ¼",groups.domestic],
    ["æµ·å¤–ãƒ¡ãƒ¼ã‚«ãƒ¼",groups.overseas],
    ["Surface",groups.surface],
    ["Apple",groups.apple]
  ].forEach(([title, arr])=>{
    const h=document.createElement("h3"); h.textContent=title; c.appendChild(h);
    const wrap=document.createElement("div"); c.appendChild(wrap);
    (arr||[]).forEach(name=>{
      const b=document.createElement("button"); b.className="btn"; b.textContent=name;
      b.onclick=()=>{state.history.push({node:state.current,choice:name}); state.current=name+"_first"; render();};
      wrap.appendChild(b);
    });
  });
}

function renderNode(node){
  const c=document.getElementById("content"); c.innerHTML="";
  if(node.type==="choice"){
    const q=document.createElement("h2"); q.textContent=node.question; c.appendChild(q);
    node.options.forEach(opt=>{
      const b=document.createElement("button"); b.className="btn"; b.textContent=opt.label;
      b.onclick=()=>{state.history.push({node:state.current,choice:opt.label}); state.current=opt.next; render();};
      c.appendChild(b);
    });
  }else{
    const box=document.createElement("div"); box.className="card";
    const h=document.createElement("h2"); h.textContent=node.title; box.appendChild(h);
    (node.details||[]).forEach(t=>{const p=document.createElement("p"); p.textContent=t; box.appendChild(p);});
    c.appendChild(box);
  }
}

function buildFlow(){
  const flow={nodes:{}}; const D=DATA;
  // Domestic
  (D.groups.domestic||[]).forEach(b=>{
    flow.nodes[b+"_first"]={type:"choice",question:"["+b+"] "+D.text.domestic.q_hasWarranty,
      options:[{label:"ã¯ã„",next:b+"_y"},{label:"ã„ã„ãˆ",next:b+"_n"}]};
    flow.nodes[b+"_y"]={type:"result",title:D.text.domestic.r_warranty_title,details:D.text.domestic.r_warranty_details};
    flow.nodes[b+"_n"]={type:"choice",question:D.text.common.q_hasNojima,
      options:[{label:"ã¯ã„",next:b+"_noj_yes"},{label:"ã„ã„ãˆ",next:b+"_pre"}]};
    flow.nodes[b+"_noj_yes"]={type:"result",title:D.text.domestic.r_nojima_ok_title,details:D.text.domestic.r_nojima_ok_details};
    flow.nodes[b+"_pre"]={type:"result",title:D.text.domestic.r_prepay_title,details:D.text.domestic.r_prepay_details};
  });
  // Overseas (æœ€åˆã®è³ªå•ã ã‘ã‚µãƒ³ãƒ—ãƒ«æ¥ç¶šãƒ»çµæœç”»é¢ã¯å…±é€šæ–‡è¨€ã«é·ç§»)
  (D.groups.overseas||[]).forEach(b=>{
    flow.nodes[b+"_first"]={type:"choice",question:"["+b+"] "+D.text.overseas.q_hasWarranty,
      options:[{label:"ã¯ã„",next:b+"_yw"},{label:"ã„ã„ãˆ",next:b+"_nw"}]};
    flow.nodes[b+"_yw"]={type:"result",title:D.text.overseas.r_store_ok_title,details:D.text.overseas.r_store_ok_details};
    flow.nodes[b+"_nw"]={type:"result",title:D.text.overseas.r_no_warranty_title,details:D.text.overseas.r_no_warranty_details.concat(D.text.overseas.r_warn_details)};
  });
  // Surface å›ºå®š
  (D.groups.surface||[]).forEach(b=>{
    flow.nodes[b+"_first"]={type:"result",title:D.text.surface.r_title,details:D.text.surface.r_details};
  });
  // Appleï¼ˆæœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ã€‚è©³ç´°åˆ†å²ã¯æ—¢å­˜ç‰ˆã«åˆã‚ã›ã¦ç·¨é›†å¯èƒ½ï¼‰
  (D.groups.apple||[]).forEach(b=>{
    flow.nodes[b+"_first"]={type:"choice",question:"["+b+"] "+D.text.apple.q_hasWarranty,
      options:[{label:"ã¯ã„",next:b+"_direct"},{label:"ã„ã„ãˆ",next:b+"_noj"}]};
    flow.nodes[b+"_direct"]={type:"result",title:D.text.apple.r_direct_title,details:D.text.apple.r_direct_details};
    flow.nodes[b+"_noj"]={type:"result",title:"ãƒã‚¸ãƒä¿è¨¼ã®é¸æŠã¸",details:["ãƒˆãƒƒãƒ—ã«æˆ»ã‚Šä¿è¨¼åˆ¥ãƒ•ãƒ­ãƒ¼ã‹ã‚‰ã”æ¡ˆå†…ãã ã•ã„ã€‚"]};
  });
  return flow;
}

function render(){
  document.getElementById("path").textContent = (state.history.length? "é€²è¡Œï¼š"+state.history.map(h=>h.choice).join(" > ") : "é€²è¡Œï¼šãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠ");
  if(state.current==="ãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠ"){ renderStart(); document.getElementById("backBtn").style.display="none"; return; }
  const node = FLOW.nodes[state.current];
  if(!node){ showError("ãƒãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: "+state.current); state.current="ãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠ"; renderStart(); return; }
  renderNode(node);
  document.getElementById("backBtn").style.display = state.history.length ? "inline-block":"none";
}

document.getElementById("resetBtn").onclick=()=>{state.history=[];state.current="ãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠ";render();};
document.getElementById("backBtn").onclick=()=>{if(!state.history.length)return;const last=state.history.pop();state.current=last.node;render();};

(async ()=>{
  try{
    DATA = await loadJSON("data.json");
  }catch(e){
    showError(e.message + " ï¼ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§æœ€ä½é™ã®UIã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
    DATA = {groups:{},text:{domestic:{},overseas:{},surface:{},apple:{},common:{}}}; // æœ€ä½é™
  }
  try{
    const logs = await loadJSON("update_log.json");
    const box = document.getElementById("history");
    box.innerHTML = logs.map(row => 
      `<div class="card"><div><b>${row.date}</b>ï½œ${row.store}ï¼ˆ${row.person}ï¼‰ï½œ${row.maker}</div><div style="color:#374151">${row.change}</div><div style="font-size:12px;color:#6b7280">${row.status}</div></div>`
    ).join("");
  }catch(e){
    document.getElementById("history").textContent="å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
  }
  FLOW = buildFlow();
  render();
})();
</script>
</body>
</html>
