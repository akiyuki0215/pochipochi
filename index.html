<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¿®ç†å—ä»˜ã‚³ãƒ³ã‚µãƒ«ãƒŠãƒ“ï¼ˆæ–°æ½Ÿã‚¨ãƒªã‚¢ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#f7f9fc; --panel:#ffffff; --ink:#0b1220; --muted:#6b7280;
      --brand:#0b6bcb; --brand-ink:#ffffff; --ok:#e9f9ef; --warn:#fff9e6; --ng:#feeeee;
      --ring: rgba(11,107,203,.25); --chip:#eef2f7;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif;color:var(--ink);background:var(--bg)}
    .container{max-width:980px;margin:0 auto;padding:16px}
    header{background:linear-gradient(90deg,#0b6bcb,#0f2b6a);color:#fff;position:sticky;top:0;z-index:10}
    header .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
    .title{font-weight:700;letter-spacing:.03em}.sub{font-size:12px;opacity:.9}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;background:#f1f5f9;color:#0b2b4a;cursor:pointer;transition:.15s;box-shadow:0 1px 0 rgba(0,0,0,.02), inset 0 0 0 1px #e5e7eb}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.08), inset 0 0 0 1px #dbe0e6}
    .btn.brand{background:var(--brand);color:var(--brand-ink);box-shadow:none}
    .card{background:var(--panel);border-radius:14px;box-shadow:0 1px 0 rgba(0,0,0,.04),0 10px 30px rgba(2,13,40,.06);padding:14px 16px;margin:14px 0}
    .section-title{font-size:18px;font-weight:700;margin:10px 0 6px}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border-radius:999px;padding:8px 12px;margin:6px 8px 6px 0;cursor:pointer;border:1px solid #e6ebf2}
    .chip:focus,.chip:active{outline:none;box-shadow:0 0 0 4px var(--ring)}
    .result{border-left:6px solid #d1e3ff;padding:10px 12px;border-radius:12px;margin:10px 0;background:var(--warn)}
    .result.ok{background:var(--ok);border-left-color:#22c55e}
    .result.warn{background:var(--warn);border-left-color:#f59e0b}
    .result.ng{background:var(--ng);border-left-color:#ef4444}
    .result h3{margin:0 0 6px;font-size:18px}.result p{margin:6px 0;line-height:1.7}
    .muted{color:var(--muted)} .row{display:flex;gap:8px;flex-wrap:wrap}
    .breadcrumb{font-size:12px;color:var(--muted);margin:6px 0 0}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    details.acd{background:var(--panel);border-radius:14px;box-shadow:0 1px 0 rgba(0,0,0,.04),0 8px 24px rgba(2,13,40,.06);padding:8px}
    details.acd > summary{list-style:none;cursor:pointer;padding:10px 12px;border-radius:12px;display:flex;gap:10px;align-items:center}
    details.acd > summary::marker, details.acd > summary::-webkit-details-marker{display:none}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px}
    .table th{color:var(--muted);font-weight:600}
  </style>
</head>
<body>
  <header>
    <div class="bar container">
      <div>
        <div class="title">ä¿®ç†å—ä»˜ã‚³ãƒ³ã‚µãƒ«ãƒŠãƒ“ï¼ˆæ–°æ½Ÿã‚¨ãƒªã‚¢ç‰ˆï¼‰</div>
        <div class="sub">ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»ä¿è¨¼ã®ãƒŠãƒ¬ãƒƒã‚¸ã‚’JSONã§ç®¡ç†ã—ã€èª°ã§ã‚‚åŒã˜åˆ¤æ–­ã‚’</div>
      </div>
      <a class="btn brand" href="https://docs.google.com/forms/d/e/1FAIpQLSc5pwJ5ahRwDdJiZNoXA0kSZ7Y9kufFVLL2kqACfH2yQFpsEA/viewform" target="_blank" rel="noopener">æ„è¦‹ã‚’é€ã‚‹ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰</a>
    </div>
  </header>

  <main class="container">
    <div id="crumb" class="breadcrumb">é€²è¡Œï¼šãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠ</div>
    <section class="card" id="panel"></section>

    <details class="acd" id="history" open>
      <summary>ğŸ•™ æ›´æ–°å±¥æ­´ï¼ˆã‚¿ãƒƒãƒ—ã§é–‹é–‰ï¼‰</summary>
      <div class="card" id="historyBody">
        <div class="muted" style="margin-bottom:6px">â€» å±¥æ­´ã¯ <span style="font-family:ui-monospace">update_log.json</span> ã‚’èª­ã¿è¾¼ã¿è¡¨ç¤ºã—ã¾ã™ã€‚ï¼ˆåˆå›ã®ã¿è¡¨ç¤ºï¼‰</div>
        <table class="table" id="historyTable">
          <thead><tr><th>æ—¥ä»˜</th><th>åº—èˆ—å</th><th>åå‰</th><th>æ›´æ–°å†…å®¹</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </details>

    <div class="controls">
      <button class="btn" id="backBtn">â† æˆ»ã‚‹</button>
      <button class="btn" id="homeBtn">æœ€åˆã‹ã‚‰</button>
    </div>
  </main>

  <script type="module">
    import { renderApple } from './vendor_apple.js';
    import { renderVAIO }  from './vendor_vaio.js';
    import { renderGeneric, renderSurface } from './vendor_generic.js';

    const $=(q,el=document)=>el.querySelector(q);
    const panel=$("#panel"), crumb=$("#crumb");
    const backBtn=$("#backBtn"), homeBtn=$("#homeBtn");
    const historyBox = $("#history");
    let DATA=null, UPDATE_LOG=null;
    let trail=[];               // ãƒ‘ãƒ³ããšè¡¨ç¤ºç”¨ï¼ˆæ–‡å­—åˆ—ï¼‰
    let viewStack=[];           // ç”»é¢å¾©å…ƒç”¨ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆ{screen, args}ï¼‰
    let historyShown=false;     // æ›´æ–°å±¥æ­´ï¼šåˆå›ã®ã¿è¡¨ç¤º

    function pushCrumb(label){ trail.push(label); syncCrumb(); }
    function popCrumb(){ trail.pop(); syncCrumb(); }
    function resetCrumb(){ trail.length=0; syncCrumb(); }
    function syncCrumb(){ crumb.textContent = "é€²è¡Œï¼š " + (trail.length?trail.join(" > "):"ãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠ"); backBtn.disabled=viewStack.length<=1; }

    // ç”»é¢é·ç§»ã®çµ±ä¸€API
    function nav(screen, args){
      viewStack.push({screen, args});
      switch(screen){
        case "home":       return _renderHome();
        case "generic":    return _renderGeneric(...args);
        case "surface":    return _renderSurface();
        case "apple":      return _renderApple(...args);
        case "vaio":       return _renderVAIO(...args);
      }
    }
    function goBack(){
      if(viewStack.length>1){
        viewStack.pop(); // ç¾åœ¨ã‚’æ¨ã¦ã‚‹
        const {screen, args}=viewStack[viewStack.length-1];
        switch(screen){
          case "home":       return _renderHome();
          case "generic":    return _renderGeneric(...args);
          case "surface":    return _renderSurface();
          case "apple":      return _renderApple(...args);
          case "vaio":       return _renderVAIO(...args);
        }
      }
    }

    backBtn.onclick = goBack;
    homeBtn.onclick = ()=> nav("home");

    function renderError(html){ panel.innerHTML=""; const div=document.createElement("div"); div.className="result ng"; div.innerHTML=`<h3>ã‚¨ãƒ©ãƒ¼</h3><p>${html}</p>`; panel.append(div); }

    function h2(t){ const el=document.createElement("div"); el.className="section-title"; el.textContent=t; return el; }
    function rowBox(){ const el=document.createElement("div"); el.className="row"; return el; }
    function chip(label, on){ const el=document.createElement("button"); el.className="chip"; el.textContent=label; el.onclick=on; return el; }

    // Home
    function _renderHome(){
      panel.innerHTML="";
      resetCrumb();
      const g=DATA.groups||{}; const sec=document.createElement("div");

      if(g.domestic?.length){
        sec.append(h2("å›½å†…ãƒ¡ãƒ¼ã‚«ãƒ¼"));
        const row=rowBox();
        g.domestic.forEach(m=>{
          row.append(chip(m,()=>{
            pushCrumb(m);
            if(m==="VAIO"){
              nav("vaio", [{panel,DATA,trail,pushCrumb,nav}]); // å°‚ç”¨
            }else{
              nav("generic", [{panel,DATA,trail,pushCrumb,nav}, m, [], false]);
            }
          }));
        });
        sec.append(row);
      }

      if(g.overseas?.length){
        sec.append(h2("æµ·å¤–ãƒ¡ãƒ¼ã‚«ãƒ¼"));
        const row=rowBox();
        g.overseas.forEach(m=> row.append(chip(m,()=>{
          pushCrumb(m);
          nav("generic", [{panel,DATA,trail,pushCrumb,nav}, m, [], true]);
        })));
        sec.append(row);
      }

      if(g.surface?.length){
        sec.append(h2("Surface"));
        const row=rowBox();
        g.surface.forEach(()=> row.append(chip("Surface",()=>{
          pushCrumb("Surface");
          nav("surface");
        })));
        sec.append(row);
      }

      if(g.apple?.length){
        sec.append(h2("Apple"));
        const row=rowBox();
        g.apple.forEach(()=> row.append(chip("Apple",()=>{
          pushCrumb("Apple");
          nav("apple", [{panel,DATA,trail,pushCrumb,nav}, []]);
        })));
        sec.append(row);
      }

      panel.append(sec);

      // æ›´æ–°å±¥æ­´ã¯åˆå›ã®ã¿è¡¨ç¤º
      if(!historyShown){
        renderHistory();
        historyShown=true;
        historyBox.style.display="";
      }else{
        historyBox.style.display="none";
      }

      syncCrumb();
    }

    // å„ãƒ¬ãƒ³ãƒ€ãƒ©ã®ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆviewStack ã¨ crumb ã‚’åŒæœŸï¼‰
    function _renderGeneric(ctx, maker, path, overseas){
      panel.innerHTML="";
      syncCrumb();
      renderGeneric(ctx, maker, path, overseas);
    }
    function _renderSurface(){
      panel.innerHTML="";
      syncCrumb();
      renderSurface({panel});
    }
    function _renderApple(ctx, path){
      panel.innerHTML="";
      syncCrumb();
      renderApple(ctx, path);
    }
    function _renderVAIO(ctx){
      panel.innerHTML="";
      syncCrumb();
      renderVAIO(ctx);
    }

    async function loadAll(){
      DATA=await safeFetchJSON("data.json");
      UPDATE_LOG=await safeFetchJSON("update_log.json");
      if(!DATA){ renderError("data.json ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚æ§‹æ–‡ã‚„é…ç½®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); return; }
      viewStack.length=0;
      nav("home");
    }

    async function safeFetchJSON(path){
      try{
        const res=await fetch(path,{cache:"no-store"});
        if(!res.ok) throw new Error(res.status+" "+res.statusText);
        return await res.json();
      }catch(e){ console.error("JSON load error:",path,e); return null; }
    }

    function renderHistory(){
      const tbody=$("#historyTable tbody"); tbody.innerHTML="";
      if(!Array.isArray(UPDATE_LOG)){
        tbody.innerHTML=`<tr><td colspan="4" class="muted">update_log.json ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€å½¢å¼ãŒä¸æ­£ã§ã™ã€‚</td></tr>`; return;
      }
      UPDATE_LOG.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.date||"-"}</td><td>${r.store||"-"}</td><td>${r.name||"-"}</td><td>${r.note||"-"}</td>`;
        tbody.append(tr);
      });
    }

    loadAll();
  </script>
</body>
</html>
